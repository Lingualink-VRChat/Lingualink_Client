<Page
    x:Class="lingualink_client.Views.LogPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:lingualink_client.ViewModels.Components"
    xmlns:models="clr-namespace:lingualink_client.Models"
    Title="LogPage"
    d:DataContext="{d:DesignInstance Type=vm:LogViewModel}"
    mc:Ignorable="d">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </Page.Resources>

    <Grid Margin="{DynamicResource PageContentMargin}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Vertical" Margin="0,0,0,12">
            <!-- Page Title -->
            <TextBlock
                Text="{Binding RunningLogLabel}"
                Style="{DynamicResource PageTitleTextBlockStyle}" />

            <StackPanel Orientation="Horizontal">
                <ui:TextBox
                    Width="260"
                    Margin="0,0,12,0"
                    Padding="8,4"
                    PlaceholderText="{Binding SearchPlaceholder}"
                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />
                <ComboBox
                    Width="200"
                    ItemsSource="{Binding CategoryOptions}"
                    SelectedValue="{Binding SelectedCategory}"
                    SelectedValuePath="Value"
                    DisplayMemberPath="Label" />
                <CheckBox
                    Margin="12,4,0,0"
                    Content="{Binding AutoScrollLabel}"
                    IsChecked="{Binding AutoScroll}" />
            </StackPanel>

            <StackPanel Orientation="Vertical" Margin="0,8,0,0">
                <TextBlock
                    FontSize="12"
                    Foreground="Gray"
                    Margin="0,0,0,4"
                    Text="{Binding LevelLabel}" />
                <WrapPanel ItemHeight="28" ItemWidth="90">
                    <CheckBox Content="{Binding TraceLabel}" IsChecked="{Binding ShowTrace}" />
                    <CheckBox Content="{Binding DebugLabel}" IsChecked="{Binding ShowDebug}" />
                    <CheckBox Content="{Binding InfoLabel}" IsChecked="{Binding ShowInfo}" />
                    <CheckBox Content="{Binding WarningLabel}" IsChecked="{Binding ShowWarning}" />
                    <CheckBox Content="{Binding ErrorLabel}" IsChecked="{Binding ShowError}" />
                    <CheckBox Content="{Binding CriticalLabel}" IsChecked="{Binding ShowCritical}" />
                </WrapPanel>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                <ui:Button
                    Margin="0,0,8,0"
                    Padding="10,6"
                    Appearance="Secondary"
                    Command="{Binding ClearLogCommand}"
                    Content="{Binding ClearLogLabel}" />
                <ui:Button
                    Margin="0,0,8,0"
                    Padding="10,6"
                    Appearance="Secondary"
                    Command="{Binding CopySelectedCommand}"
                    CommandParameter="{Binding SelectedItems, ElementName=LogListBox}"
                    Content="{Binding CopySelectedLabel}" />
                <ui:Button
                    Margin="0,0,8,0"
                    Padding="10,6"
                    Appearance="Secondary"
                    Command="{Binding CopyAllCommand}"
                    Content="{Binding CopyAllLabel}" />
                <ui:Button
                    Margin="0,0,8,0"
                    Padding="10,6"
                    Appearance="Secondary"
                    Command="{Binding ExportCommand}"
                    CommandParameter="markdown"
                    Content="{Binding ExportMarkdownLabel}" />
                <ui:Button
                    Padding="10,6"
                    Appearance="Secondary"
                    Command="{Binding ExportCommand}"
                    CommandParameter="json"
                    Content="{Binding ExportJsonLabel}" />
            </StackPanel>
        </StackPanel>

        <ListBox
            x:Name="LogListBox"
            Grid.Row="1"
            ItemsSource="{Binding EntriesView}"
            SelectionMode="Extended"
            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
            Padding="0,0,12,12"
            BorderThickness="0"
            Background="Transparent">

            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem" BasedOn="{StaticResource DefaultListBoxItemStyle}">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0,0,0,8" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                </Style>
            </ListBox.ItemContainerStyle>

            <ListBox.ItemTemplate>
                <DataTemplate>
                    <ui:Card Padding="12" Margin="0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Header Row -->
                            <Grid Grid.Row="0" Margin="0,0,0,6">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/> <!-- Level -->
                                    <ColumnDefinition Width="Auto"/> <!-- Time -->
                                    <ColumnDefinition Width="*"/>    <!-- Category -->
                                </Grid.ColumnDefinitions>

                                <!-- Level Badge -->
                                <Border Grid.Column="0" CornerRadius="4" Padding="6,2" Margin="0,0,8,0"
                                        x:Name="LevelBadge">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorSecondaryBrush}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Warning}">
                                                    <Setter Property="Background" Value="#40FFA500"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Error}">
                                                    <Setter Property="Background" Value="#40FF0000"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Critical}">
                                                    <Setter Property="Background" Value="#408B0000"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Debug}">
                                                    <Setter Property="Background" Value="#20808080"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    
                                    <TextBlock Text="{Binding Level}" FontSize="11" FontWeight="Bold"
                                               x:Name="LevelText">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Warning}">
                                                        <Setter Property="Foreground" Value="#D0FFA500"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Error}">
                                                        <Setter Property="Foreground" Value="#FFFF0000"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Critical}">
                                                        <Setter Property="Foreground" Value="#FFFF0000"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Debug}">
                                                        <Setter Property="Foreground" Value="Gray"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>

                                <!-- Time -->
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding Timestamp, StringFormat=HH:mm:ss.fff}"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           FontSize="12" VerticalAlignment="Center" Margin="0,0,8,0"/>

                                <!-- Category -->
                                <TextBlock Grid.Column="2"
                                           Text="{Binding Category}"
                                           FontWeight="SemiBold"
                                           TextTrimming="CharacterEllipsis"
                                           HorizontalAlignment="Right"
                                           Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"
                                           FontSize="12" VerticalAlignment="Center"/>
                            </Grid>

                            <!-- Message -->
                            <TextBlock Grid.Row="1" 
                                       Text="{Binding Message}" 
                                       TextWrapping="Wrap" 
                                       FontSize="13"
                                       Margin="0,2,0,0" />

                            <!-- Details -->
                            <TextBlock Grid.Row="2"
                                       x:Name="DetailsBox"
                                       Text="{Binding Details}"
                                       TextWrapping="Wrap"
                                       Margin="0,8,0,0"
                                       FontFamily="Consolas"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Details}" Value="">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Details}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </ui:Card>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
    </Grid>
</Page>
