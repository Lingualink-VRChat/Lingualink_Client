# Release Notes – 3.4.8

## 简体中文 (zh-CN)

- **fix:** 修复消息模板页面在加载设置时意外重写 `app_settings.json`，导致自定义模板文本在进入页面后被清空的问题，现在仅在用户实际修改时才保存。
- **feat:** 为麦克风管理器新增“记住上次选择的设备”功能，优先按设备 ID 恢复上次使用的麦克风，如不存在则回退到系统默认或第一个可用设备。
- **fix:** 修复账号设置页“使用自定义服务器”开关状态无法正确持久化的问题，现在会随其他账号设置一并写入 `app_settings.json` 并在重启后恢复。
- **feat:** 将官方服务与自定义服务器拆分为两套独立配置（`OfficialServerUrl` / `OfficialApiKey` 与 `CustomServerUrl` / `CustomApiKey`），切换开关时会记住各自的 URL 和密钥，方便来回切换而不互相覆盖。
- **improve:** 改进“测试连接”按钮的错误反馈逻辑，`/health` 检查失败时会返回具体的 HTTP 状态码或异常信息，而不再统一显示 “An unknown error occurred”。
- **refactor:** 抽取全局语言应用与保存逻辑为 `AppLanguageHelper`，统一 `GlobalLanguage` 的读写路径，减少各页面/服务对语言细节的重复实现。
- **refactor:** 进一步收紧设置相关 ViewModel 的依赖和死代码（例如清理未使用的 `SettingsService` 字段、移除无效初始化方法），为后续可选依赖注入和测试铺路。
- **refactor:** 新增 `ISettingsManager`/`SettingsManager` 作为设置读写与事件发布的统一入口，并让账号设置页、服务设置页、消息模板页以及文本输入/主页只读场景统一通过它访问 `AppSettings`，显著减少重复的 `LoadSettings`/`SaveSettings`/`SettingsChangedEvent` 管道代码。
- **refactor:** 简化多语言刷新逻辑，多个 ViewModel 不再逐个手写 `LanguageManager.LanguageChanged += () => OnPropertyChanged(nameof(XXXLabel));` 列表，而是统一通过 `OnPropertyChanged(string.Empty)` 触发整页本地化绑定刷新，降低新增文案时的维护成本。
- **improve:** 提升剪贴板复制的稳定性：日志面板和会话历史在复制文本时改用基于 Win32 API 的 `ClipboardHelper.TrySetText`，在远程桌面/剪贴板同步工具（如 RustDesk）临时占用剪贴板时通过重试机制降低 `ExternalException` 失败概率。

## English (en)

- **fix:** Fixed an issue where opening the message template page could overwrite `app_settings.json` and clear `UserCustomTemplateText`; settings are now only saved when the user actually edits the template.
- **feat:** Added “remember last selected microphone” support in the microphone manager, restoring the last device by ID on startup and falling back to the system default or first available device when necessary.
- **fix:** Persisted the “Use custom server” toggle on the account page so the selected mode survives restarts instead of always defaulting to the custom server.
- **feat:** Split official and custom server configuration into two separate sets (`OfficialServerUrl` / `OfficialApiKey` and `CustomServerUrl` / `CustomApiKey`), allowing you to switch modes without losing either configuration.
- **improve:** Improved the “Test connection” flow to surface detailed HTTP status/exception messages from the `/health` endpoint instead of always reporting “An unknown error occurred.”
- **refactor:** Introduced `AppLanguageHelper` to centralize applying and persisting `GlobalLanguage`, reducing duplicated language logic across pages and services.
- **refactor:** Tightened settings-related view models by removing unused `SettingsService` fields and obsolete initialization methods, improving cohesion for future optional DI and testing.
- **refactor:** Introduced `ISettingsManager`/`SettingsManager` as a single entry point for loading, updating, saving, and broadcasting `AppSettings` changes, and migrated the account/service/message-template pages plus TextEntry/IndexWindow read-only paths to use it, significantly reducing duplicated `LoadSettings`/`SaveSettings`/`SettingsChangedEvent` pipelines.
- **refactor:** Simplified localization refresh patterns by replacing long chains of `LanguageManager.LanguageChanged += () => OnPropertyChanged(nameof(XXXLabel));` with a single `OnPropertyChanged(string.Empty)` per view model, making it easier to keep UI labels in sync when adding or changing localized strings.
- **improve:** Hardened clipboard operations for log and conversation history copy actions by routing them through a Win32-based `ClipboardHelper.TrySetText`, adding retries to reduce `ExternalException` failures when third-party tools (e.g., remote desktop or clipboard sync apps) temporarily lock the clipboard.

