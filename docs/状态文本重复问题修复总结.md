# LinguaLink Client 状态文本重复问题修复总结

## 问题描述

在音频监听过程中，状态文本出现重复显示的问题，例如：
- 显示为："状态：正在监听...: 检测到语音..."
- 应该显示："状态：检测到语音..."

## 问题原因分析

### 原问题代码
在 `IndexWindowViewModel.OnAudioServiceStatusUpdate` 方法中：

```csharp
private void OnAudioServiceStatusUpdate(object? sender, string status)
{
    Application.Current.Dispatcher.Invoke(() => {
        StatusText = LanguageManager.GetString("StatusListening").Split(':')[0] + ": " + status;
        AddLogMessage($"AudioService Status: {status}");
    });
}
```

### 问题分析
1. **AudioService发送的状态**：
   - `AudioStatusListening`: "正在监听..."（纯状态描述）
   - `AudioStatusSpeechDetected`: "检测到语音..."（纯状态描述）

2. **IndexWindowViewModel的错误处理**：
   - 代码试图从 `StatusListening`（"状态：正在监听..."）中提取前缀"状态"
   - 然后与AudioService发送的status拼接
   - 导致重复：`"状态" + ": " + "检测到语音..."` = `"状态: 检测到语音..."`

3. **根本问题**：
   - AudioService发送的是纯状态描述（不含"状态:"前缀）
   - IndexWindowViewModel错误地使用了包含前缀的字符串来提取前缀
   - 造成逻辑混乱和文本重复

## 解决方案

### 1. 修复 OnAudioServiceStatusUpdate 方法

**修复前：**
```csharp
StatusText = LanguageManager.GetString("StatusListening").Split(':')[0] + ": " + status;
```

**修复后：**
```csharp
StatusText = string.Format(LanguageManager.GetString("StatusPrefix"), status);
```

### 2. 添加新的本地化字符串

**英文版本 (Properties/Lang.resx)：**
```xml
<data name="StatusPrefix" xml:space="preserve">
  <value>Status: {0}</value>
</data>
```

**中文版本 (Properties/Lang.zh-CN.resx)：**
```xml
<data name="StatusPrefix" xml:space="preserve">
  <value>状态：{0}</value>
</data>
```

## 修复效果

### 修复前的问题
- 英文："Status: Listening...: Speech detected..." ❌
- 中文："状态：正在监听...: 检测到语音..." ❌

### 修复后的正确显示
- 英文："Status: Speech detected..." ✅
- 中文："状态：检测到语音..." ✅

## AudioService状态类型

AudioService发送的所有状态都是纯描述性文本，现在都会正确添加本地化前缀：

| AudioService状态 | 英文显示 | 中文显示 |
|-----------------|---------|---------|
| AudioStatusListening | Status: Listening... | 状态：正在监听... |
| AudioStatusSpeechDetected | Status: Speech detected... | 状态：检测到语音... |
| AudioStatusSpeechDetectedSplit | Status: Speech detected (split)... | 状态：检测到语音 (已切分)... |
| AudioStatusSilenceDetectedProcess | Status: Silence detected, preparing to process... | 状态：检测到静音，准备处理... |
| AudioStatusSegmentTooShort | Status: Audio segment too short, ignored. Listening... | 状态：语音片段过短，已忽略。正在监听... |

## 多语言兼容性

通过使用 `StatusPrefix` 本地化字符串模板，这个修复：
1. ✅ 支持当前的英文和中文
2. ✅ 易于扩展到其他语言
3. ✅ 保持了状态前缀的一致性
4. ✅ 避免了硬编码字符串拼接

## 测试建议

1. 测试应用启动和停止监听
2. 测试从"正在监听"到"检测到语音"的状态切换
3. 测试语言切换时状态文本的正确显示
4. 测试各种AudioService状态（错误、分割等）
5. 验证日志中的状态记录正确性

确保所有状态文本都不再出现重复，且多语言显示正确。 